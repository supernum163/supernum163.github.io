
setwd("nnet")

source("utils.R")
source("layers.R")
source("optimizer.R")
source("nnet.R")


# 1表示先手方棋子，-1表示后手方棋子，0表示空棋位
input <- c(
  -1,  0,  0,   0,  1,  0,   0,  0,  0, 
   0, -1,  0,   0,  1,  0,   0,  0,  0, 
  -1,  0,  0,   0,  0,  0,   0,  1,  0, 
   0, -1,  0,   1,  0,  0,   0,  0,  0, 
   0,  0, -1,   0,  0,  0,   0,  0,  1, 
  -1,  1,  0,   0,  1,  0,   0,  0,  0, 
  -1,  0,  1,   0,  1,  0,   0,  0,  0, 
  -1,  0,  0,   0,  1,  1,   0,  0,  0, 
  -1,  0,  0,   0,  1,  0,   0,  0,  1, 
  -1, -1,  1,   0,  1,  0,   0,  0,  0, 
  -1,  0,  1,  -1,  1,  0,   0,  0,  0, 
  -1,  0,  1,   0,  1, -1,   0,  0,  0, 
  -1,  0,  1,   0,  1,  0,  -1,  0,  0, 
  -1,  0,  1,   0,  1,  0,   0, -1,  0, 
  -1,  0,  1,   0,  1,  0,   0,  0, -1, 
  -1,  1,  1,   0,  1,  0,  -1,  0,  0, 
  -1,  0,  1,   1,  1,  0,  -1,  0,  0, 
  -1,  0,  1,   0,  1,  1,  -1,  0,  0, 
  -1,  0,  1,   0,  1,  0,  -1,  1,  0, 
  -1,  0,  1,   0,  1,  0,  -1,  0,  1, 
  -1, -1,  1,   1,  1,  0,  -1,  0,  0, 
  -1,  0,  1,   1,  1, -1,  -1,  0,  0, 
  -1,  0,  1,   1,  1,  0,  -1, -1,  0, 
  -1,  0,  1,   1,  1,  0,  -1,  0, -1, 
  -1,  1,  1,   1,  1, -1,  -1,  0,  0, 
  -1,  0,  1,   1,  1, -1,  -1,  1,  0,   
  -1,  0,  1,   1,  1, -1,  -1,  0,  1, 
  -1, -1,  1,   1,  1, -1,  -1,  1,  0, 
  -1,  0,  1,   1,  1, -1,  -1,  1, -1,  
  -1, -1,  1,   1,  1, -1,  -1,  1,  1, 

   1,  1,  1,  -1,  0, -1,   0,  0,  0, 
   1,  1,  1,  -1,  0,  0,   0, -1,  0, 
   1,  1,  1,   0, -1,  0,   0, -1,  0, 
   1,  1,  1,  -1, -1,  1,  -1,  0,  0,
   1,  1,  1,  -1,  1, -1,   0, -1,  0, 
   1,  1,  1,  -1,  1,  0,  -1, -1,  0, 
   0, -1,  0,   1,  1,  1,   0, -1,  0, 
  -1,  0,  0,   1,  1,  1,   0, -1,  0,   
  -1,  0,  0,   1,  1,  1,   0,  0, -1, 
  -1,  1,  0,   1,  1,  1,   0, -1, -1,
  -1,  1,  0,   1,  1,  1,   0, -1, -1, 
  -1, -1,  1,   1,  1,  1,   0, -1,  0, 
   1,  0,  0,   1,  0,  0,   1, -1, -1, 
   1,  0, -1,   1,  0,  0,   1, -1,  0, 
   1,  0,  0,   1,  0, -1,   1,  0, -1, 
   1,  0, -1,   1,  1,  0,   1, -1, -1, 
   1, -1,  1,   1,  0,  0,   1, -1, -1,   
   1, -1,  0,   1,  0,  1,   1, -1, -1, 
   0,  1,  0,   0,  1,  0,  -1,  1, -1, 
   0,  1, -1,   0,  1,  0,  -1,  1,  0, 
   0,  1,  0,   0,  1, -1,   0,  1, -1, 
   0,  1, -1,   1,  1,  0,  -1,  1, -1, 
  -1,  1,  1,   0,  1,  0,  -1,  1, -1,   
  -1,  1,  0,   0,  1,  1,  -1,  1, -1,  
   1,  0, -1,   0,  1,  0,  -1,  0,  1, 
   1, -1,  0,   0,  1,  0,  -1,  0,  1, 
   1,  0,  0,  -1,  1,  0,  -1,  0,  1, 
   1,  0, -1,   0,  1,  1,  -1, -1,  1, 
  -1,  1,  1,   0,  1, -1,   1,  0, -1, 
  -1,  0,  1,   0,  1,  1,   1, -1, -1, 

  -1, -1, -1,   1,  1,  0,   0,  0,  0, 
  -1, -1, -1,   1,  0,  0,   0,  0,  1, 
  -1, -1, -1,   0,  0,  1,   0,  1,  0, 
  -1, -1, -1,   1,  1, -1,   0,  1,  0,
  -1, -1, -1,   1, -1,  1,   0,  0,  1, 
  -1, -1, -1,   1, -1,  0,   0,  1,  1, 
   0,  0,  1,  -1, -1, -1,   0,  1,  0, 
   1,  0,  0,  -1, -1, -1,   1,  0,  0,   
   1,  0,  0,  -1, -1, -1,   0,  0,  1, 
   1, -1,  0,  -1, -1, -1,   1,  0,  1,
   1, -1,  0,  -1, -1, -1,   1,  1,  0, 
   1,  0, -1,  -1, -1, -1,   1,  1,  0, 
  -1,  1,  0,  -1,  0,  0,  -1,  0,  1, 
  -1,  0,  1,  -1,  0,  0,  -1,  1,  0, 
  -1,  0,  1,  -1,  0,  0,  -1,  0,  1, 
  -1,  1,  0,  -1, -1,  0,  -1,  1,  1, 
  -1,  1, -1,  -1,  0,  1,  -1,  0,  1,   
  -1,  1,  0,  -1,  1, -1,  -1,  0,  1, 
   0, -1,  0,   1, -1,  0,   0, -1,  1, 
   0, -1,  1,   0, -1,  0,   0, -1,  1, 
   1, -1,  0,   0, -1,  1,   0, -1,  0, 
   0, -1,  0,  -1, -1,  1,   1, -1,  1, 
   1, -1, -1,   1, -1,  0,   0, -1,  1,   
   1, -1,  1,   0, -1, -1,   1, -1,  0,  
   0,  0, -1,   1, -1,  0,  -1,  0,  1, 
   0,  1, -1,   1, -1,  0,  -1,  0,  0, 
   1,  1, -1,   0, -1,  0,  -1,  0,  0, 
  -1,  0, -1,   0, -1,  1,  -1,  1,  1, 
  -1, -1,  1,   0, -1,  1,   1,  0, -1, 
  -1, -1,  1,   0, -1,  1,   0,  1, -1
)
input <- matrix(input, ncol = 9, byrow = TRUE)
input <- array(input, dim = c(90, 1, 3, 3))
# 1表示两方都没有获胜， 2表示先手方获胜，3表示后手方获胜
output <- rep(1:3, each = 30)
output <- matrix(output, ncol = 1)

# 使用神经网络判断井字棋胜负
nnet <- Nnet(dim(input), dim(output))
LAYER$Convolution(nnet, filter_size = 16, filter_h = 3, filter_w = 3, castToMat = TRUE)
LAYER$ReLU(nnet)
LAYER$Affine(nnet, n = 3, "ReLU")
LAYER$LAST$SoftmaxWithLoss(nnet)
OPTIMIZER$Adam(nnet, lr = 0.1)
nnet$fFeed <- function(nnet) {
  n <- sample(1:90, 30)
  nnet$data$input0 <- input[n, , , , drop = FALSE]
  nnet$data$output <- output[n, , drop = FALSE]
  nnet$batch <- 30
}
nnet$train(500)
plot(nnet$losses)
pred <- nnet$predict(input)
yhat <- apply(pred, 1, which.max)
sum(yhat == as.vector(output)) / 90

# 测试训练结果
test <- c(  
   0,  0, -1,   0,  0,  0,   1,  0,  0, 
  -1,  0,  1,   1,  0,  0,   0,  0, -1, 
  -1,  1,  1,   1,  1, -1,   0, -1,  0, 
   1,  1,  1,  -1,  1,  0,  -1,  0, -1, 
   1,  1, -1,   1,  0,  0,   1, -1, -1, 
   1, -1,  0,   0,  1,  0,   0, -1,  1, 
   1,  0, -1,  -1, -1, -1,   1,  0,  1,
   0, -1,  0,   0, -1,  1,   0, -1,  1, 
  -1,  1, -1,   0, -1,  1,   0,  1, -1
)
test <- matrix(test, ncol = 9, byrow = TRUE)
test <- array(test, dim = c(9, 1, 3, 3))
pred <- nnet$predict(test)
apply(pred, 1, which.max)

# 这里样本数量还是不够，容易过度拟合


